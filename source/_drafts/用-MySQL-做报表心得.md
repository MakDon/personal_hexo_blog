---
title: 用 MySQL 做报表心得
tags: []
id: '189'
categories:
  - - 数据结构与算法
---

## 例子

产品

地区

代理商

包装规格

容量

包装

销量

成本

收入

毛利

件均成本

件均收益

日期

可乐

南区

某A

350m易拉罐

350

易拉罐

500

500.00

1000.00

500.00

1.00

1.00

9.1

可乐

东区

某A

500m易拉罐

500

易拉罐

500

500.00

1000.00

500.00

1.00

1.00

9.1

可乐

北区

某B

350m易拉罐

350

易拉罐

500

500.00

1000.00

500.00

1.00

1.00

9.1

可乐

西区

某B

2500m塑料瓶

250

塑料瓶

500

500.00

1000.00

500.00

1.00

1.00

9.1

纯净水

中区

某B

350m塑料瓶

350

塑料瓶

500

500.00

1000.00

500.00

1.00

1.00

9.1

假定我们需要一张如上图的日报表。其中假定一个地区只有一个代理商，代理商可以代理多个地区。我们需要从这个表上面看到销量、总成本、总收入、毛利等数据。  
需求可能包括：

*   过滤：筛选某些项，例如，只看 350 容量的数据。此时我们需要展现的内容为：

产品

地区

代理商

包装规格

容量

包装

销量

成本

收入

毛利

件均成本

件均收益

日期

可乐

南区

某A

350m易拉罐

350

易拉罐

500

500.00

1000.00

500.00

1.00

1.00

9.1

可乐

北区

某B

350m易拉罐

350

易拉罐

500

500.00

1000.00

500.00

1.00

1.00

9.1

纯净水

中区

某B

350m塑料瓶

350

塑料瓶

500

500.00

1000.00

500.00

1.00

1.00

9.1

*   聚合：只以某些（一个或多个）维度查看数据，例如，只看 `包装` 的维度（groupBy 包装方式）：

包装

销量

成本

收入

毛利

件均成本

件均收益

日期

易拉罐

1500

1500.00

3000.00

1500.00

1.00

1.00

9.1

塑料瓶

1000

1000.00

2000.00

1000.00

1.00

1.00

9.1

*   展示：分页、按某列排序、只看前 x 条、看汇总、以百分比查看等展示需求

## 列

以上面的报表为例，我们首先把一张表的列（column）分为两类，维度（dimension）和度量（metric）

维度：例如`产品`,`地区`,`包装规格` 等，就是维度，标识该行数据的归属

度量：例如`销量`,`成本`,`收入` 等，为度量。

我们描述表中一列的时候，通常是这样描述的 9月1日（维度）的易拉罐包装（维度）的销量（度量）为1500，总成本（度量）为 1500

### 维度

从例子可以看到，有些维度之间是有相互关联关系的。如”一个地区只有一个代理商“、”包装规格包含了容量和包装方式“等。因此，给定地区即可得出代理商，给定包装规格即可以得出容量和包装方式。  
所以我们可以把维度分为两类（以下两个词是我自己定义的）：

*   最小维度：如`产品`,`日期`,`包装规格`,等，这些维度不会再被细分为更细的维度，或可从其它维度推断。
*   派生维度：如`代理商`、`容量`。当我们知道`产品`后，就可以得出`代理商`的值；当我们知道`包装规格`后，就可以得出`容量`。因此 `代理商`、`容量` 都是派生维度

另外，在日期报表内，日期几乎是最常见的维度。报表的数值通常都是围绕时间和时间区间进行，例如我们需要看每天、每个月的统计数据（聚合）或者看特别某些时间区间的数据（过滤）。因此，在一些开源组件（如 druid）会把时间维度独立为一个特殊的必选的列。

### 度量

*   独立度量: 不依赖于其它数据的度量，如”销量“、”成本“
*   聚合度量: 由其它多个度量以公式计算得出的度量，如”件均成本=成本/销量“、”件均收益=（收入-成本)/销量“

另外还有一些状态类度量（可以是独立度量或者是聚合度量），如:

```
天气：
多云
晴天
暴雨

库存状态：
当库存> 500 时充足
当库存<= 500 >0 时紧缺
当库存 =0 时售罄
```

在本篇暂时不作讨论，暂时只讨论数值类度量。

## 表设计

我们开始进行 MySQL 表的设计。

首先我们把呈现于前端的报表的度量跟维度列举出来

最小维度: 产品、地区、包装规格、日期 派生维度：代理商、容量、包装 独立度量：销量、成本、收入 聚合度量：毛利、件均成本、件均收益

首先把每一个维度对应表的一个 column，无论是最小维度还是派生维度。

*   最小维度对应一个 column的原因不再赘述。
*   派生维度也建议对应一个 column，如上述例子，”代理商“为派生维度，但是有时候需要看某几个代理商的单日销量，就需要对”代理商“进行 where 筛选后 groupby。在表内留有冗余的字段有利于更快的查询。 需要注意的是，若最小维度与派生维度的映射关系可能发生变更，则不建议维护此冗余列，以避免绑定关系变更时需要对所有历史数据进行更新。此时个人更倾向于维护单独的关系映射表。上述例子中，若地区的代理商可能会变更，则需要维护一张”地区-代理商“关系表，同时在报表内不记录代理商字段。

然后把每一个独立度量对应一个 column。我们假定地区与代理商的多对一关系有可能变更，于是我们可以得出这两张表：

*   销售额报表

产品

地区

包装规格

容量

包装

销量

成本

收入

日期

可乐

南区

350m易拉罐

350

易拉罐

500

500.00

1000.00

9.1

可乐

东区

500m易拉罐

500

易拉罐

500

500.00

1000.00

9.1

可乐

北区

350m易拉罐

350

易拉罐

500

500.00

1000.00

9.1

可乐

西区

2500m塑料瓶

250

塑料瓶

500

500.00

1000.00

9.1

纯净水

中区

350m塑料瓶

350

塑料瓶

500

500.00

1000.00

9.1

*   地区-代理商映射表（最小维度-派生维度映射表）

地区

代理商

日期

南区

某A

9.1

东区

某A

9.1

北区

某B

9.1

西区

某B

9.1

中区

某B

9.1

## 查询

这里把所有查询动作抽象为 3个动作：过滤、聚合、展现。假定我们有个需求：只查看 9月1日中 350 容量的数据，并按照代理商维度查看。我们想要看到的目标表就是：

代理商

销量

成本

收入

毛利

件均成本

件均收益

日期

某A

500

500.00

1000.00

500.00

1.00

1.00

9.1

某B

1000

1000.00

2000.00

1000.00

1.00

1.00

9.1

使用 buttom-up 的顺序组装 SQL。首先进行过滤，我们可以很简单的写出这样的 SQL

```SQL
Select *
From table_report
Where capacity=350
    AND report_date="2020-09-01"
```

和 映射表的 SQL

```SQL
Select *
From area_agent_index
Where report_date="2020-09-01"
```

然后进行聚合。个人认为聚合包括表的关联和数据的统计。对应的 SQL 就是 Join 和 groupby  
先进行 join 表 join 表时 ON 选择两个表维度的交集。如果两个表都涉及度量，则需要 groupby 交集度量，并对度量列进行聚合

```SQL
Select *
From 
(
    Select *
    From table_report
    Where capacity=350
)AS table_report
JOIN 
(
    Select *
    From area_agent_index
    Where report_date="2020-09-01"
) AS area_agent_index
ON table_report.area_id=area_agent_index.area_id 
    AND table_report.report_date=area_agent_index.report_date 
```

然后进行 groupBy，加总独立度量，计算聚合度量 所以这里在 Select 时，选取选定的维度、SUM 所有独立维度、使用业务给定的公式计算计算聚合维度。

```SQL
Select agent
    , report_date
    , SUM(sales) AS sales
    , SUM(cost) AS cost
    , SUM(income) AS income
    , SUM(income) - SUM(cost) AS profit
    , SUM(cost)/SUM(sales) AS CPP
    , (SUM(income) - SUM(cost))/SUM(sales) AS BPP
From 
(
    Select *
    From table_report
    Where capacity=350
)AS table_report
JOIN 
(
    Select *
    From area_agent_index
    Where report_date="2020-09-01"
) AS area_agent_index
ON table_report.area_id=area_agent_index.area_id
```

最后进行展现的调整。常见的前端展现如分页、求总条数、按照某个度量排序等，在此层解决。